<!DOCTYPE html>
<html>
  <head>
    <title>Fruit comparison</title>
  </head>
  <body>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//d3js.org/d3.v5.min.js"></script>

      <!-- define bar chart frame and size  -->
    <svg width="1000" height="500"></svg>

    <!-- dropdown menu  -->
    <select id="d3-dropdown">
      <option value="Carbohydrate, by difference in gram">"Carbohydrates (gram)"</option>
      <option value="Energy in kcal">"Energy (kcal)"</option>
      <option value="Fiber, total dietary in gram">"Fiber (gram)"</option>
      <option value="Folate, DFE in microgram">"Folate/B11 (microgram)"</option>
      <option value="Iron, Fe in milligram">"Iron (milligram)"</option>
      <option value="Magnesium, Mg in milligram">"Magnesium (milligram)"</option>
      <option value="Niacin in milligram">"Niacin/B3 (milligram)"</option>
      <option value="Phosphorus, P in milligram">"Phosphorus (milligram)"</option>
      <option value="Potassium, K in milligram">"Potassium (milligram)"</option>
      <option value="Riboflavin in milligram">"Riboflavin/B2 (milligram)"</option>
      <option value="Sugars, total in gram">"Sugars (gram)"</option>
      <option value="Thiamin in milligram">"Thiamin/B1 (milligram)"</option>
      <!-- <option value="Vitamin A, IU in IU">"Vitamin A IU (international units)"</option> -->
      <option value="Vitamin A, RAE in microgram">"Vitamin A (microgram)"</option>
      <option value="Vitamin B-6 in milligram">"Vitamin B-6 (milligram)"</option>
      <option value="Vitamin C, total ascorbic acid in milligram">"Vitamin C (milligram)"</option>
    </select>

    <p id="selected-dropdown"></p>

    <script>

    d3.select("select")
      .on("change",function(d){

        d3.selectAll("svg > *").remove();

        var svg = d3.select("svg"),
          margin = {top: 20, right: 20, bottom: 60, left: 80},
          width = +svg.attr("width") - margin.left - margin.right,
          height = +svg.attr("height") - margin.top - margin.bottom;

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");

        var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
            y = d3.scaleLinear().rangeRound([height, 0]);

        var colours = d3.scaleOrdinal()
          .range(["#6F257F", "#CA0D59"]);

        var g = svg.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var selected = d3.select("#d3-dropdown").node().value;


        selected = selected.toString();

        console.log( selected );
        console.log("thirteenth");

        d3.select("#selected-dropdown").text(selected);

        // load json file
        d3.json("nutrients.json").then(function (data) {

          console.log(data);


          // extract fruit names
          fruitkeys = Object.keys(data);

          nutrientkeys = Object.keys(data["Apple"]);
          // console.log(nutrientkeys);


          // initialize list of dicts for figure formation
          figuredata = []

          // loop through nutrition dict of each fruit
          for (i = 0; i < fruitkeys.length; i++) {

            // dict of nutrients per fruit
            nutrients = data[fruitkeys[i]];

            // isolate single nutrient value
            carbs = nutrients[selected];

            // console.log(carbs);

            var dict = {"Fruit": fruitkeys[i], "Carbs": carbs}
            // console.log(dict);

            figuredata.push(dict);
          };

          console.log(figuredata);

          x.domain(figuredata.map(function(d) { return d.Fruit; }));
          y.domain([0, d3.max(figuredata, function(d) { return d.Carbs; })]);

          g.append("g")
              .attr("class", "axis axis--x")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom(x))
              .selectAll("text")
              .style("text-anchor", "right")
              .attr("dx", "1.5em")
              .attr("dy", "2.5em")
              .attr("transform", "rotate(25)");


          g.append("g")
              .attr("class", "axis axis--y")
              .call(d3.axisLeft(y).ticks(5).tickFormat(function(d) { return d; }).tickSizeInner([-width]))
            .append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", -35)
              .attr("dy", "0.71em")
              .attr("text-anchor", "end")
              .attr("fill", "#5D6971")
              .text(selected);

          g.selectAll(".bar")
              .data(figuredata)
            .enter().append("rect")
              .attr("x", function(d) { return x(d.Fruit); })
              .attr("y", function(d) { return y(d.Carbs); })
              .attr("width", x.bandwidth())
              .attr("height", function(d) { return height - y(d.Carbs); })
              .attr("fill", function(d) { return colours(d.Fruit); })
              .on("mousemove", function(d){
                  tooltip
                    .style("left", d3.event.pageX - 50 + "px")
                    .style("top", d3.event.pageY - 70 + "px")
                    .style("display", "inline-block")
                    .html((d.Fruit) + "<br>" + "Â£" + (d.Carbs));
              })
              .on("mouseout", function(d){ tooltip.style("display", "none");});
           });

           g.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("text-decoration", "underline")
            .text("Value vs Date Graph");

    })

    </script>
  </body>
</html>
